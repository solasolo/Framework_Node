import { DefaultThen } from 'TestToolkit';
import { GUID } from 'CommonUtils';
import { PgAccessor, MrAccessor, Entities } from 'DataAccess';
import { DateTime } from 'DateTime';
import { SysLogger } from 'Logger';
SysLogger.Append(['Console']);

let conObject: any = {
    host: 'localhost',
    user: 'test',
    password: 'nopassword',
    database: 'Test',
    db: 'Test',
    max: 10,
    idleTimeoutMillis: 30000,
    charset: 'utf8'
};

let dbPg = new PgAccessor(conObject);
let dbMr = new MrAccessor(conObject);

let NewObject: any = {
    ID: GUID.New32(),
    Time: DateTime.Now(),
    Value: Math.round(Math.random() * 1000),
    Name: "测试",
    Price: 25.3,
    Data: {
        Result: '你好',
        Value: 1024,
        Status: true
    }
};

let entMr = Entities.Define(dbMr, 'test');
let entPg = Entities.Define(dbPg, 'Test');

// entMr.LoadSchema('testtable').then(Success, Error);
// entPg.LoadSchema('Test').then(Success, Error);

async function MrTest() {
    console.log('MI', await entMr.New(NewObject));
    console.log('MU', await entMr.Update(NewObject));
    let obj = await entMr.Get(NewObject.ID);
    console.log(DateTime.Now());
    console.log(obj.Time);
    console.log(obj.Price);
    console.log(obj.Value);

    console.log('MS', obj);
    console.log('MS', await entMr.Set(NewObject));

    console.log('MUC', await entMr.Update({
        ID: NewObject.ID,
        Name: 'XXX'
    }));
}

async function PgTest() {
    console.log('PI', await entPg.New(NewObject));
    console.log('PU', await entPg.Update(NewObject));
    console.log('PS', await entPg.Get(NewObject.ID));
    console.log('PS', await entPg.Set(NewObject));
}


DefaultThen(MrTest());
DefaultThen(PgTest());

/*
const router = new (require('WebService').RestfulRouter)();

async(router.Parse(path.resolve(__dirname, "../../.."))).then(
    function (d) {
    },
    function (e) {
        console.error(e);
    }
);
*/